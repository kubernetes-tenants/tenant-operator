# Prometheus Alert Rules for Lynq
# These alerts monitor node health, conflicts, and failures
#
# To deploy these alerts:
# 1. Install prometheus-operator in your cluster
# 2. Apply this file: kubectl apply -f config/prometheus/alerts.yaml
# 3. Configure AlertManager to send notifications

apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: lynq-alerts
  namespace: lynq-system
  labels:
    app: lynq
    prometheus: kube-prometheus
spec:
  groups:
    # ========================================
    # Critical Alerts - Immediate Action Required
    # ========================================
    - name: lynq.critical
      interval: 30s
      rules:
        # Critical: LynqNode is in degraded state
        - alert: LynqNodeDegraded
          expr: max by (lynqnode, namespace, reason) (lynqnode_degraded_status) > 0
          for: 5m
          labels:
            severity: critical
            component: lynq
          annotations:
            summary: "LynqNode {{ $labels.lynqnode }} is degraded ({{ $labels.reason }})"
            description: "LynqNode {{ $labels.lynqnode }} in namespace {{ $labels.namespace }} has been in degraded state for 5+ minutes. Reason: {{ $labels.reason }}. This may indicate template errors, conflicts, or dependency issues."
            dashboard: "https://grafana.example.com/d/lynq/node-details?var-lynqnode={{ $labels.lynqnode }}&var-namespace={{ $labels.namespace }}"
            runbook_url: "https://lynq.sh/alert-runbooks#lynqnodedegraded"

        # Critical: LynqNode has failed resources
        - alert: LynqNodeResourcesFailed
          expr: lynqnode_resources_failed > 0
          for: 5m
          labels:
            severity: critical
            component: lynq
          annotations:
            summary: "LynqNode {{ $labels.lynqnode }} has {{ $value }} failed resource(s)"
            description: "LynqNode {{ $labels.lynqnode }} in namespace {{ $labels.namespace }} has {{ $value }} failed resources for 5+ minutes. This indicates critical provisioning failure."
            dashboard: "https://grafana.example.com/d/lynq/node-details?var-lynqnode={{ $labels.lynqnode }}&var-namespace={{ $labels.namespace }}"
            runbook_url: "https://lynq.sh/alert-runbooks#lynqnoderesourcesfailed"

        # Critical: LynqNode not ready for extended period
        - alert: LynqNodeNotReady
          expr: lynqnode_condition_status{type="Ready"} == 0
          for: 15m
          labels:
            severity: critical
            component: lynq
          annotations:
            summary: "LynqNode {{ $labels.lynqnode }} not ready for 15+ minutes"
            description: "LynqNode {{ $labels.lynqnode }} in namespace {{ $labels.namespace }} has been not ready for more than 15 minutes. Immediate investigation required."
            dashboard: "https://grafana.example.com/d/lynq/node-details?var-lynqnode={{ $labels.lynqnode }}&var-namespace={{ $labels.namespace }}"
            runbook_url: "https://lynq.sh/alert-runbooks#lynqnodenotready"

        # Critical: LynqNode in unknown state
        - alert: LynqNodeStatusUnknown
          expr: lynqnode_condition_status{type="Ready"} == 2
          for: 10m
          labels:
            severity: critical
            component: lynq
          annotations:
            summary: "LynqNode {{ $labels.lynqnode }} status unknown"
            description: "LynqNode {{ $labels.lynqnode }} in namespace {{ $labels.namespace }} has been in unknown state for 10+ minutes. This indicates potential controller or API server issues."
            dashboard: "https://grafana.example.com/d/lynq/node-details?var-lynqnode={{ $labels.lynqnode }}&var-namespace={{ $labels.namespace }}"
            runbook_url: "https://lynq.sh/alert-runbooks#lynqnodestatusunknown"

        # Critical: Hub has widespread node failures
        - alert: HubManyNodesFailure
          expr: hub_failed > 5 or (hub_failed / hub_desired > 0.5 and hub_desired > 0)
          for: 5m
          labels:
            severity: critical
            component: lynq
          annotations:
            summary: "Hub {{ $labels.hub }} has widespread failures"
            description: "Hub {{ $labels.hub }} in namespace {{ $labels.namespace }} has {{ $value }} failed nodes (>5 or >50% of desired). This indicates a systemic issue requiring immediate attention."
            dashboard: "https://grafana.example.com/d/lynq/hub-overview?var-hub={{ $labels.hub }}&var-namespace={{ $labels.namespace }}"
            runbook_url: "https://lynq.sh/alert-runbooks#hubmanynodesfailure"

    # ========================================
    # Warning Alerts - Attention Required
    # ========================================
    - name: lynq.warning
      interval: 30s
      rules:
        # Warning: LynqNode resources not matching desired state
        - alert: LynqNodeResourcesMismatch
          expr: |
            (lynqnode_resources_ready != lynqnode_resources_desired)
            and (lynqnode_resources_desired > 0)
            and (lynqnode_resources_failed == 0)
          for: 15m
          labels:
            severity: warning
            component: lynq
          annotations:
            summary: "LynqNode {{ $labels.lynqnode }} has resource count mismatch"
            description: "LynqNode {{ $labels.lynqnode }} in namespace {{ $labels.namespace }} has {{ $labels.lynqnode_resources_ready }} ready resources but desires {{ $labels.lynqnode_resources_desired }}. No failures detected but reconciliation may be stuck."
            dashboard: "https://grafana.example.com/d/lynq/node-details?var-lynqnode={{ $labels.lynqnode }}&var-namespace={{ $labels.namespace }}"
            runbook_url: "https://lynq.sh/alert-runbooks#lynqnoderesourcesmismatch"

        # Warning: LynqNode has conflicted resources
        - alert: LynqNodeResourcesConflicted
          expr: lynqnode_resources_conflicted > 0
          for: 10m
          labels:
            severity: warning
            component: lynq
          annotations:
            summary: "LynqNode {{ $labels.lynqnode }} has {{ $value }} conflicted resource(s)"
            description: "LynqNode {{ $labels.lynqnode }} in namespace {{ $labels.namespace }} has {{ $value }} resources in conflict state. This usually indicates ownership conflicts with existing resources."
            dashboard: "https://grafana.example.com/d/lynq/node-details?var-lynqnode={{ $labels.lynqnode }}&var-namespace={{ $labels.namespace }}"
            runbook_url: "https://lynq.sh/alert-runbooks#lynqnoderesourcesconflicted"

        # Warning: High rate of conflicts
        - alert: LynqNodeHighConflictRate
          expr: rate(lynqnode_conflicts_total[5m]) > 0.1
          for: 10m
          labels:
            severity: warning
            component: lynq
          annotations:
            summary: "High conflict rate for node {{ $labels.lynqnode }}"
            description: "LynqNode {{ $labels.lynqnode }} in namespace {{ $labels.namespace }} is experiencing {{ printf \"%.2f\" $value }} conflicts/sec for {{ $labels.resource_kind }}. Policy: {{ $labels.conflict_policy }}. Review naming templates or conflict policies."
            dashboard: "https://grafana.example.com/d/lynq/node-details?var-lynqnode={{ $labels.lynqnode }}&var-namespace={{ $labels.namespace }}"
            runbook_url: "https://lynq.sh/alert-runbooks#lynqnodehighconflictrate"

        # Warning: Hub has failed nodes
        - alert: HubNodesFailure
          expr: hub_failed > 0 and hub_failed <= 5
          for: 10m
          labels:
            severity: warning
            component: lynq
          annotations:
            summary: "Hub {{ $labels.hub }} has {{ $value }} failed node(s)"
            description: "Hub {{ $labels.hub }} in namespace {{ $labels.namespace }} has {{ $value }} failed nodes for 10+ minutes. This may indicate provisioning issues affecting some nodes."
            dashboard: "https://grafana.example.com/d/lynq/hub-overview?var-hub={{ $labels.hub }}&var-namespace={{ $labels.namespace }}"
            runbook_url: "https://lynq.sh/alert-runbooks#hubnodesfailure"

        # Warning: Hub sync issues
        - alert: HubDesiredCountMismatch
          expr: |
            (hub_ready != hub_desired)
            and (hub_desired > 0)
            and (hub_failed == 0)
          for: 20m
          labels:
            severity: warning
            component: lynq
          annotations:
            summary: "Hub {{ $labels.hub }} has node count mismatch"
            description: "Hub {{ $labels.hub }} in namespace {{ $labels.namespace }} has {{ $labels.hub_ready }} ready nodes but desires {{ $labels.hub_desired }}. No failures detected but sync may be delayed."
            dashboard: "https://grafana.example.com/d/lynq/hub-overview?var-hub={{ $labels.hub }}&var-namespace={{ $labels.namespace }}"
            runbook_url: "https://lynq.sh/alert-runbooks#hubdesiredcountmismatch"

        # Warning: High reconciliation error rate
        - alert: LynqNodeReconciliationErrors
          expr: |
            sum(rate(lynqnode_reconcile_duration_seconds_count{result="error"}[5m]))
            /
            sum(rate(lynqnode_reconcile_duration_seconds_count[5m]))
            > 0.1
          for: 10m
          labels:
            severity: warning
            component: lynq
          annotations:
            summary: "High node reconciliation error rate"
            description: "LynqNode operator is experiencing {{ humanizePercentage $value }} error rate in reconciliations. This may indicate controller issues, API server problems, or resource contention."
            dashboard: "https://grafana.example.com/d/lynq/controller-health"
            runbook_url: "https://lynq.sh/alert-runbooks#lynqnodereconciliationerrors"

        # Warning: Slow reconciliation (P95)
        - alert: LynqNodeReconciliationSlow
          expr: |
            histogram_quantile(0.95,
              sum by (le) (rate(lynqnode_reconcile_duration_seconds_bucket{result="success"}[5m]))
            ) > 30
          for: 15m
          labels:
            severity: warning
            component: lynq
          annotations:
            summary: "Slow node reconciliation detected"
            description: "95th percentile of successful node reconciliation duration is {{ printf \"%.1f\" $value }}s (threshold: 30s). This may indicate performance issues, resource contention, or complex node configurations."
            dashboard: "https://grafana.example.com/d/lynq/controller-health"
            runbook_url: "https://lynq.sh/alert-runbooks#lynqnodereconciliationslow"

        # Warning: High apply failure rate
        - alert: HighApplyFailureRate
          expr: |
            sum by (kind) (rate(apply_attempts_total{result="failure"}[5m]))
            /
            sum by (kind) (rate(apply_attempts_total[5m]))
            > 0.2
          for: 10m
          labels:
            severity: warning
            component: lynq
          annotations:
            summary: "High apply failure rate for {{ $labels.kind }}"
            description: "Resource kind {{ $labels.kind }} is experiencing {{ humanizePercentage $value }} apply failure rate. Review resource templates and RBAC permissions."
            dashboard: "https://grafana.example.com/d/lynq/controller-health"
            runbook_url: "https://lynq.sh/alert-runbooks#highapplyfailurerate"

    # ========================================
    # Info Alerts - Informational
    # ========================================
    - name: lynq.info
      interval: 1m
      rules:
        # Info: New conflicts detected
        - alert: LynqNodeNewConflictsDetected
          expr: increase(lynqnode_conflicts_total[5m]) > 0
          for: 2m
          labels:
            severity: info
            component: lynq
          annotations:
            summary: "New conflicts detected for node {{ $labels.lynqnode }}"
            description: "LynqNode {{ $labels.lynqnode }} in namespace {{ $labels.namespace }} encountered {{ printf \"%.0f\" $value }} new conflict(s) in the last 5 minutes for {{ $labels.resource_kind }}. Conflict policy: {{ $labels.conflict_policy }}."
            dashboard: "https://grafana.example.com/d/lynq/node-details?var-lynqnode={{ $labels.lynqnode }}&var-namespace={{ $labels.namespace }}"
            runbook_url: "https://lynq.sh/alert-runbooks#lynqnoderesourcesconflicted"
