import{_ as n,c as a,o as l,a2 as e}from"./chunks/framework.9Uv4PgnO.js";const y=JSON.parse('{"title":"Runbook: High Apply Failure Rate","description":"","frontmatter":{},"headers":[],"relativePath":"runbooks/apply-failures.md","filePath":"runbooks/apply-failures.md","lastUpdated":1762417427000}'),p={name:"runbooks/apply-failures.md"};function o(r,s,t,c,i,u){return l(),a("div",null,[...s[0]||(s[0]=[e(`<h1 id="runbook-high-apply-failure-rate" tabindex="-1">Runbook: High Apply Failure Rate <a class="header-anchor" href="#runbook-high-apply-failure-rate" aria-label="Permalink to &quot;Runbook: High Apply Failure Rate&quot;">​</a></h1><h2 id="alert-details" tabindex="-1">Alert Details <a class="header-anchor" href="#alert-details" aria-label="Permalink to &quot;Alert Details&quot;">​</a></h2><p><strong>Alert Name:</strong> <code>HighApplyFailureRate</code><strong>Severity:</strong> Warning <strong>Threshold:</strong> sum(rate(apply_attempts_total{result=&quot;failure&quot;}[5m])) by (kind) / sum(rate(apply_attempts_total[5m])) by (kind) &gt; 0.2 for 10+ minutes</p><h2 id="description" tabindex="-1">Description <a class="header-anchor" href="#description" aria-label="Permalink to &quot;Description&quot;">​</a></h2><p>This alert fires when a specific resource kind is experiencing a high apply failure rate (&gt;20% of apply attempts failing sustained for 10+ minutes). This indicates systemic issues with applying resources of that particular kind, suggesting RBAC issues, API server problems, or invalid resource specifications.</p><h2 id="symptoms" tabindex="-1">Symptoms <a class="header-anchor" href="#symptoms" aria-label="Permalink to &quot;Symptoms&quot;">​</a></h2><ul><li>High failure rate for specific resource kind (Deployment, Service, etc.)</li><li>Resources of specific kind not being created/updated</li><li>Events showing repeated apply failures</li><li>Tenants failing with consistent pattern for one resource type</li></ul><h2 id="possible-causes" tabindex="-1">Possible Causes <a class="header-anchor" href="#possible-causes" aria-label="Permalink to &quot;Possible Causes&quot;">​</a></h2><ol><li><p><strong>RBAC Permission Issues</strong></p><ul><li>Operator lacks permissions for specific resource kind</li><li>Cross-namespace permission issues</li><li>ClusterRole or RoleBinding misconfigured</li><li>ServiceAccount permissions revoked</li></ul></li><li><p><strong>Resource Validation Failures</strong></p><ul><li>Invalid resource specifications in templates</li><li>API schema violations</li><li>Required fields missing</li><li>Type mismatches in resource specs</li></ul></li><li><p><strong>Admission Webhook Rejections</strong></p><ul><li>ValidatingWebhook rejecting resources</li><li>MutatingWebhook causing conflicts</li><li>Policy violations (OPA, Kyverno, etc.)</li><li>Custom admission controllers blocking</li></ul></li><li><p><strong>API Server Issues</strong></p><ul><li>API server rejecting specific resource kind</li><li>CRD not installed or misconfigured</li><li>API version deprecation or removal</li><li>Resource type disabled in API server</li></ul></li><li><p><strong>Quota or Limit Issues</strong></p><ul><li>Namespace resource quotas for specific kind</li><li>Cluster-wide limits on resource count</li><li>Object count limits per namespace</li><li>API server object limits</li></ul></li><li><p><strong>Template Issues</strong></p><ul><li>Invalid template rendering for specific resource kind</li><li>Missing required template variables</li><li>Type conversion errors in templates</li><li>Malformed YAML in spec</li></ul></li></ol><h2 id="diagnosis" tabindex="-1">Diagnosis <a class="header-anchor" href="#diagnosis" aria-label="Permalink to &quot;Diagnosis&quot;">​</a></h2><h3 id="_1-identify-failing-resource-kind" tabindex="-1">1. Identify Failing Resource Kind <a class="header-anchor" href="#_1-identify-failing-resource-kind" aria-label="Permalink to &quot;1. Identify Failing Resource Kind&quot;">​</a></h3><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># Check apply failure rate by kind</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> logs</span><span style="color:#79B8FF;"> -n</span><span style="color:#9ECBFF;"> tenant-operator-system</span><span style="color:#79B8FF;"> -l</span><span style="color:#9ECBFF;"> app=tenant-operator</span><span style="color:#79B8FF;"> --tail=2000</span><span style="color:#79B8FF;"> \\</span></span>
<span class="line"><span style="color:#F97583;">  |</span><span style="color:#B392F0;"> grep</span><span style="color:#79B8FF;"> -i</span><span style="color:#9ECBFF;"> &quot;apply failed\\|apply error&quot;</span><span style="color:#79B8FF;"> \\</span></span>
<span class="line"><span style="color:#F97583;">  |</span><span style="color:#B392F0;"> awk</span><span style="color:#9ECBFF;"> &#39;{for(i=1;i&lt;=NF;i++) if($i~/kind=/) print $i}&#39;</span><span style="color:#79B8FF;"> \\</span></span>
<span class="line"><span style="color:#F97583;">  |</span><span style="color:#B392F0;"> sort</span><span style="color:#F97583;"> |</span><span style="color:#B392F0;"> uniq</span><span style="color:#79B8FF;"> -c</span><span style="color:#F97583;"> |</span><span style="color:#B392F0;"> sort</span><span style="color:#79B8FF;"> -rn</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Get specific error messages for failing kind</span></span>
<span class="line"><span style="color:#E1E4E8;">FAILING_KIND</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;Deployment&quot;</span><span style="color:#6A737D;">  # Replace with actual failing kind</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> logs</span><span style="color:#79B8FF;"> -n</span><span style="color:#9ECBFF;"> tenant-operator-system</span><span style="color:#79B8FF;"> -l</span><span style="color:#9ECBFF;"> app=tenant-operator</span><span style="color:#79B8FF;"> --tail=1000</span><span style="color:#79B8FF;"> \\</span></span>
<span class="line"><span style="color:#F97583;">  |</span><span style="color:#B392F0;"> grep</span><span style="color:#9ECBFF;"> &quot;kind=</span><span style="color:#E1E4E8;">$FAILING_KIND</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#F97583;"> |</span><span style="color:#B392F0;"> grep</span><span style="color:#79B8FF;"> -i</span><span style="color:#9ECBFF;"> &quot;error\\|failed&quot;</span><span style="color:#F97583;"> |</span><span style="color:#B392F0;"> head</span><span style="color:#79B8FF;"> -10</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="_2-check-rbac-permissions" tabindex="-1">2. Check RBAC Permissions <a class="header-anchor" href="#_2-check-rbac-permissions" aria-label="Permalink to &quot;2. Check RBAC Permissions&quot;">​</a></h3><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># Check if operator can create the failing resource kind</span></span>
<span class="line"><span style="color:#E1E4E8;">RESOURCE_KIND</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;deployments&quot;</span><span style="color:#6A737D;">  # Use lowercase plural</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> auth</span><span style="color:#9ECBFF;"> can-i</span><span style="color:#9ECBFF;"> create</span><span style="color:#E1E4E8;"> $RESOURCE_KIND </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#79B8FF;">  --as=system:serviceaccount:tenant-operator-system:tenant-operator-controller-manager</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Check all verbs for this resource</span></span>
<span class="line"><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> verb </span><span style="color:#F97583;">in</span><span style="color:#9ECBFF;"> get</span><span style="color:#9ECBFF;"> list</span><span style="color:#9ECBFF;"> watch</span><span style="color:#9ECBFF;"> create</span><span style="color:#9ECBFF;"> update</span><span style="color:#9ECBFF;"> patch</span><span style="color:#9ECBFF;"> delete</span><span style="color:#E1E4E8;">; </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#79B8FF;">  echo</span><span style="color:#79B8FF;"> -n</span><span style="color:#9ECBFF;"> &quot;</span><span style="color:#E1E4E8;">$verb</span><span style="color:#E1E4E8;"> $RESOURCE_KIND</span><span style="color:#9ECBFF;">: &quot;</span></span>
<span class="line"><span style="color:#B392F0;">  kubectl</span><span style="color:#9ECBFF;"> auth</span><span style="color:#9ECBFF;"> can-i</span><span style="color:#E1E4E8;"> $verb $RESOURCE_KIND </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#79B8FF;">    --as=system:serviceaccount:tenant-operator-system:tenant-operator-controller-manager</span></span>
<span class="line"><span style="color:#F97583;">done</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Check cross-namespace permissions</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> auth</span><span style="color:#9ECBFF;"> can-i</span><span style="color:#9ECBFF;"> create</span><span style="color:#E1E4E8;"> $RESOURCE_KIND </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#79B8FF;">  --as=system:serviceaccount:tenant-operator-system:tenant-operator-controller-manager</span><span style="color:#79B8FF;"> \\</span></span>
<span class="line"><span style="color:#79B8FF;">  --namespace=</span><span style="color:#F97583;">&lt;</span><span style="color:#79B8FF;">target-namespace</span><span style="color:#F97583;">&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="_3-check-resource-specifications" tabindex="-1">3. Check Resource Specifications <a class="header-anchor" href="#_3-check-resource-specifications" aria-label="Permalink to &quot;3. Check Resource Specifications&quot;">​</a></h3><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># Get sample failed resource spec from tenant</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get</span><span style="color:#9ECBFF;"> tenants</span><span style="color:#79B8FF;"> --all-namespaces</span><span style="color:#79B8FF;"> -o</span><span style="color:#9ECBFF;"> json</span><span style="color:#79B8FF;"> \\</span></span>
<span class="line"><span style="color:#F97583;">  |</span><span style="color:#B392F0;"> jq</span><span style="color:#79B8FF;"> -r</span><span style="color:#9ECBFF;"> &quot;.items[] | select(.status.failedResources &gt; 0) | .spec.\${</span><span style="color:#E1E4E8;">FAILING_KIND</span><span style="color:#9ECBFF;">}s[0]&quot;</span><span style="color:#79B8FF;"> \\</span></span>
<span class="line"><span style="color:#F97583;">  |</span><span style="color:#B392F0;"> head</span><span style="color:#79B8FF;"> -1</span><span style="color:#F97583;"> &gt;</span><span style="color:#9ECBFF;"> /tmp/failed-resource.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Validate against API server (dry-run)</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> create</span><span style="color:#79B8FF;"> -f</span><span style="color:#9ECBFF;"> /tmp/failed-resource.yaml</span><span style="color:#79B8FF;"> --dry-run=server</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="_4-check-for-admission-webhooks" tabindex="-1">4. Check for Admission Webhooks <a class="header-anchor" href="#_4-check-for-admission-webhooks" aria-label="Permalink to &quot;4. Check for Admission Webhooks&quot;">​</a></h3><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># List validating webhooks</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get</span><span style="color:#9ECBFF;"> validatingwebhookconfigurations</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># List mutating webhooks</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get</span><span style="color:#9ECBFF;"> mutatingwebhookconfigurations</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Check if any webhook is blocking the resource kind</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get</span><span style="color:#9ECBFF;"> validatingwebhookconfigurations</span><span style="color:#79B8FF;"> -o</span><span style="color:#9ECBFF;"> json</span><span style="color:#79B8FF;"> \\</span></span>
<span class="line"><span style="color:#F97583;">  |</span><span style="color:#B392F0;"> jq</span><span style="color:#79B8FF;"> -r</span><span style="color:#9ECBFF;"> &#39;.items[] | select(.webhooks[].rules[].resources[]? == &quot;&#39;</span><span style="color:#E1E4E8;">$RESOURCE_KIND</span><span style="color:#9ECBFF;">&#39;&quot;s&quot;) | .metadata.name&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Check webhook logs if available</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> logs</span><span style="color:#79B8FF;"> -n</span><span style="color:#F97583;"> &lt;</span><span style="color:#9ECBFF;">webhook-namespac</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;"> -l</span><span style="color:#F97583;"> &lt;</span><span style="color:#9ECBFF;">webhook-selecto</span><span style="color:#E1E4E8;">r</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;"> --tail=200</span><span style="color:#79B8FF;"> \\</span></span>
<span class="line"><span style="color:#F97583;">  |</span><span style="color:#B392F0;"> grep</span><span style="color:#79B8FF;"> -i</span><span style="color:#9ECBFF;"> &quot;</span><span style="color:#E1E4E8;">$RESOURCE_KIND</span><span style="color:#9ECBFF;">\\|denied\\|rejected&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="_5-check-quota-and-limits" tabindex="-1">5. Check Quota and Limits <a class="header-anchor" href="#_5-check-quota-and-limits" aria-label="Permalink to &quot;5. Check Quota and Limits&quot;">​</a></h3><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># Check resource quotas</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get</span><span style="color:#9ECBFF;"> resourcequotas</span><span style="color:#79B8FF;"> --all-namespaces</span><span style="color:#79B8FF;"> \\</span></span>
<span class="line"><span style="color:#79B8FF;">  -o</span><span style="color:#9ECBFF;"> json</span><span style="color:#F97583;"> |</span><span style="color:#B392F0;"> jq</span><span style="color:#79B8FF;"> -r</span><span style="color:#9ECBFF;"> &#39;.items[] | select(.spec.hard | keys[] | contains(&quot;&#39;</span><span style="color:#E1E4E8;">$RESOURCE_KIND</span><span style="color:#9ECBFF;">&#39;&quot;)) | &quot;\\(.metadata.namespace) \\(.metadata.name)&quot;&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Check specific namespace quota</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> describe</span><span style="color:#9ECBFF;"> resourcequota</span><span style="color:#79B8FF;"> -n</span><span style="color:#F97583;"> &lt;</span><span style="color:#9ECBFF;">namespac</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Check API server limits</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get</span><span style="color:#79B8FF;"> --raw</span><span style="color:#9ECBFF;"> /api/v1</span><span style="color:#F97583;"> |</span><span style="color:#B392F0;"> jq</span><span style="color:#79B8FF;"> -r</span><span style="color:#9ECBFF;"> &#39;.resources[] | select(.name==&quot;&#39;</span><span style="color:#E1E4E8;">$RESOURCE_KIND</span><span style="color:#9ECBFF;">&#39;s&quot;) | .namespaced&#39;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_6-analyze-template-for-failing-resource" tabindex="-1">6. Analyze Template for Failing Resource <a class="header-anchor" href="#_6-analyze-template-for-failing-resource" aria-label="Permalink to &quot;6. Analyze Template for Failing Resource&quot;">​</a></h3><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># Get template that&#39;s generating failing resources</span></span>
<span class="line"><span style="color:#E1E4E8;">TEMPLATE_NAME</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&quot;&lt;template-name&gt;&quot;</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get</span><span style="color:#9ECBFF;"> tenanttemplate</span><span style="color:#E1E4E8;"> $TEMPLATE_NAME </span><span style="color:#79B8FF;">-n</span><span style="color:#F97583;"> &lt;</span><span style="color:#9ECBFF;">namespac</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;"> \\</span></span>
<span class="line"><span style="color:#79B8FF;">  -o</span><span style="color:#9ECBFF;"> yaml</span><span style="color:#F97583;"> |</span><span style="color:#B392F0;"> grep</span><span style="color:#79B8FF;"> -A</span><span style="color:#79B8FF;"> 50</span><span style="color:#9ECBFF;"> &quot;\${</span><span style="color:#E1E4E8;">FAILING_KIND</span><span style="color:#9ECBFF;">}s:&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Check for template syntax errors</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get</span><span style="color:#9ECBFF;"> tenanttemplate</span><span style="color:#E1E4E8;"> $TEMPLATE_NAME </span><span style="color:#79B8FF;">-n</span><span style="color:#F97583;"> &lt;</span><span style="color:#9ECBFF;">namespac</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;"> \\</span></span>
<span class="line"><span style="color:#79B8FF;">  -o</span><span style="color:#9ECBFF;"> jsonpath=&quot;{.spec.\${</span><span style="color:#E1E4E8;">FAILING_KIND</span><span style="color:#9ECBFF;">}s[*].spec}&quot;</span><span style="color:#F97583;"> |</span><span style="color:#B392F0;"> jq</span><span style="color:#9ECBFF;"> .</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="_7-check-api-server-events" tabindex="-1">7. Check API Server Events <a class="header-anchor" href="#_7-check-api-server-events" aria-label="Permalink to &quot;7. Check API Server Events&quot;">​</a></h3><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># Get events related to the failing resource kind</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get</span><span style="color:#9ECBFF;"> events</span><span style="color:#79B8FF;"> --all-namespaces</span><span style="color:#79B8FF;"> --sort-by=</span><span style="color:#9ECBFF;">&#39;.lastTimestamp&#39;</span><span style="color:#79B8FF;"> \\</span></span>
<span class="line"><span style="color:#F97583;">  |</span><span style="color:#B392F0;"> grep</span><span style="color:#79B8FF;"> -i</span><span style="color:#9ECBFF;"> &quot;</span><span style="color:#E1E4E8;">$FAILING_KIND</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#F97583;"> |</span><span style="color:#B392F0;"> tail</span><span style="color:#79B8FF;"> -20</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Check for API server rejections</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get</span><span style="color:#9ECBFF;"> events</span><span style="color:#79B8FF;"> --all-namespaces</span><span style="color:#79B8FF;"> \\</span></span>
<span class="line"><span style="color:#79B8FF;">  -o</span><span style="color:#9ECBFF;"> json</span><span style="color:#F97583;"> |</span><span style="color:#B392F0;"> jq</span><span style="color:#79B8FF;"> -r</span><span style="color:#9ECBFF;"> &#39;.items[] | select(.reason==&quot;FailedCreate&quot; or .reason==&quot;FailedUpdate&quot;) | select(.involvedObject.kind==&quot;&#39;</span><span style="color:#E1E4E8;">$FAILING_KIND</span><span style="color:#9ECBFF;">&#39;&quot;) | &quot;\\(.lastTimestamp) \\(.message)&quot;&#39;</span><span style="color:#79B8FF;"> \\</span></span>
<span class="line"><span style="color:#F97583;">  |</span><span style="color:#B392F0;"> tail</span><span style="color:#79B8FF;"> -10</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="resolution" tabindex="-1">Resolution <a class="header-anchor" href="#resolution" aria-label="Permalink to &quot;Resolution&quot;">​</a></h2><h3 id="for-rbac-permission-issues" tabindex="-1">For RBAC Permission Issues <a class="header-anchor" href="#for-rbac-permission-issues" aria-label="Permalink to &quot;For RBAC Permission Issues&quot;">​</a></h3><ol><li><p><strong>Verify ClusterRole has required permissions:</strong></p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get</span><span style="color:#9ECBFF;"> clusterrole</span><span style="color:#9ECBFF;"> tenant-operator-manager-role</span><span style="color:#79B8FF;"> -o</span><span style="color:#9ECBFF;"> yaml</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p><strong>Add missing permissions:</strong></p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> edit</span><span style="color:#9ECBFF;"> clusterrole</span><span style="color:#9ECBFF;"> tenant-operator-manager-role</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Add rule for failing resource kind:</span></span>
<span class="line"><span style="color:#B392F0;">-</span><span style="color:#9ECBFF;"> apiGroups:</span></span>
<span class="line"><span style="color:#B392F0;">    -</span><span style="color:#9ECBFF;"> &quot;apps&quot;</span><span style="color:#6A737D;">  # or appropriate API group</span></span>
<span class="line"><span style="color:#B392F0;">  resources:</span></span>
<span class="line"><span style="color:#B392F0;">    -</span><span style="color:#9ECBFF;"> deployments</span><span style="color:#6A737D;">  # failing resource kind</span></span>
<span class="line"><span style="color:#B392F0;">  verbs:</span></span>
<span class="line"><span style="color:#B392F0;">    -</span><span style="color:#9ECBFF;"> get</span></span>
<span class="line"><span style="color:#B392F0;">    -</span><span style="color:#9ECBFF;"> list</span></span>
<span class="line"><span style="color:#B392F0;">    -</span><span style="color:#9ECBFF;"> watch</span></span>
<span class="line"><span style="color:#B392F0;">    -</span><span style="color:#9ECBFF;"> create</span></span>
<span class="line"><span style="color:#B392F0;">    -</span><span style="color:#9ECBFF;"> update</span></span>
<span class="line"><span style="color:#B392F0;">    -</span><span style="color:#9ECBFF;"> patch</span></span>
<span class="line"><span style="color:#B392F0;">    -</span><span style="color:#9ECBFF;"> delete</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div></li><li><p><strong>For cross-namespace resources:</strong></p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># Ensure ClusterRole (not Role) is used</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get</span><span style="color:#9ECBFF;"> clusterrolebinding</span><span style="color:#9ECBFF;"> tenant-operator-manager-rolebinding</span><span style="color:#79B8FF;"> -o</span><span style="color:#9ECBFF;"> yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Verify it binds ClusterRole to service account</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li><li><p><strong>Reapply RBAC if needed:</strong></p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> apply</span><span style="color:#79B8FF;"> -f</span><span style="color:#9ECBFF;"> config/rbac/</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div></li></ol><h3 id="for-resource-validation-failures" tabindex="-1">For Resource Validation Failures <a class="header-anchor" href="#for-resource-validation-failures" aria-label="Permalink to &quot;For Resource Validation Failures&quot;">​</a></h3><ol><li><p><strong>Fix template specification:</strong></p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> edit</span><span style="color:#9ECBFF;"> tenanttemplate</span><span style="color:#F97583;"> &lt;</span><span style="color:#9ECBFF;">template-nam</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;"> -n</span><span style="color:#F97583;"> &lt;</span><span style="color:#9ECBFF;">namespac</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Common fixes:</span></span>
<span class="line"><span style="color:#6A737D;"># - Add required fields (e.g., spec.selector for Deployments)</span></span>
<span class="line"><span style="color:#6A737D;"># - Fix field types (e.g., replicas should be integer not string)</span></span>
<span class="line"><span style="color:#6A737D;"># - Correct API version</span></span>
<span class="line"><span style="color:#6A737D;"># - Fix nested object structures</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li><li><p><strong>Validate template changes:</strong></p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># Extract resource spec</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get</span><span style="color:#9ECBFF;"> tenanttemplate</span><span style="color:#F97583;"> &lt;</span><span style="color:#9ECBFF;">template-nam</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;"> -n</span><span style="color:#F97583;"> &lt;</span><span style="color:#9ECBFF;">namespac</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;"> \\</span></span>
<span class="line"><span style="color:#79B8FF;">  -o</span><span style="color:#9ECBFF;"> jsonpath=&#39;{.spec.deployments[0].spec}&#39;</span><span style="color:#F97583;"> &gt;</span><span style="color:#9ECBFF;"> /tmp/test-resource.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Test with dry-run</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> create</span><span style="color:#79B8FF;"> -f</span><span style="color:#9ECBFF;"> /tmp/test-resource.yaml</span><span style="color:#79B8FF;"> --dry-run=server</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li><li><p><strong>Add default values for optional fields:</strong></p><div class="language-yaml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#85E89D;">spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">  deployments</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">    - </span><span style="color:#85E89D;">id</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">app</span></span>
<span class="line"><span style="color:#85E89D;">      spec</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">        replicas</span><span style="color:#E1E4E8;">: {{ </span><span style="color:#9ECBFF;">.replicas | default 1</span><span style="color:#E1E4E8;"> }}  </span><span style="color:#6A737D;"># Provide default</span></span>
<span class="line"><span style="color:#85E89D;">        selector</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">          matchLabels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">            app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .uid }}-app&quot;</span></span>
<span class="line"><span style="color:#85E89D;">        template</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">          metadata</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">            labels</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#85E89D;">              app</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">&quot;{{ .uid }}-app&quot;</span><span style="color:#6A737D;">  # Must match selector</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div></li></ol><h3 id="for-admission-webhook-rejections" tabindex="-1">For Admission Webhook Rejections <a class="header-anchor" href="#for-admission-webhook-rejections" aria-label="Permalink to &quot;For Admission Webhook Rejections&quot;">​</a></h3><ol><li><p><strong>Identify blocking webhook:</strong></p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># Check webhook configurations</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get</span><span style="color:#9ECBFF;"> validatingwebhookconfigurations</span><span style="color:#79B8FF;"> -o</span><span style="color:#9ECBFF;"> yaml</span><span style="color:#79B8FF;"> \\</span></span>
<span class="line"><span style="color:#F97583;">  |</span><span style="color:#B392F0;"> grep</span><span style="color:#79B8FF;"> -A</span><span style="color:#79B8FF;"> 10</span><span style="color:#9ECBFF;"> &quot;</span><span style="color:#E1E4E8;">$RESOURCE_KIND</span><span style="color:#9ECBFF;">&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li><li><p><strong>Review webhook logs:</strong></p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># Find webhook pod</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get</span><span style="color:#9ECBFF;"> pods</span><span style="color:#79B8FF;"> -A</span><span style="color:#79B8FF;"> -l</span><span style="color:#F97583;"> &lt;</span><span style="color:#9ECBFF;">webhook-selecto</span><span style="color:#E1E4E8;">r</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Check logs</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> logs</span><span style="color:#79B8FF;"> -n</span><span style="color:#F97583;"> &lt;</span><span style="color:#9ECBFF;">namespac</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#F97583;"> &lt;</span><span style="color:#9ECBFF;">webhook-po</span><span style="color:#E1E4E8;">d</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;"> --tail=200</span><span style="color:#79B8FF;"> \\</span></span>
<span class="line"><span style="color:#F97583;">  |</span><span style="color:#B392F0;"> grep</span><span style="color:#79B8FF;"> -i</span><span style="color:#9ECBFF;"> &quot;denied\\|rejected&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li><li><p><strong>Options to resolve:</strong></p><p><strong>Option A: Fix resource to comply with policy</strong></p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> edit</span><span style="color:#9ECBFF;"> tenanttemplate</span><span style="color:#F97583;"> &lt;</span><span style="color:#9ECBFF;">template-nam</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;"> -n</span><span style="color:#F97583;"> &lt;</span><span style="color:#9ECBFF;">namespac</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#6A737D;"># Adjust spec to meet policy requirements</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>Option B: Exclude operator from webhook (if appropriate)</strong></p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> edit</span><span style="color:#9ECBFF;"> validatingwebhookconfiguration</span><span style="color:#F97583;"> &lt;</span><span style="color:#9ECBFF;">webhook-nam</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Add namespace selector to exclude operator:</span></span>
<span class="line"><span style="color:#B392F0;">namespaceSelector:</span></span>
<span class="line"><span style="color:#B392F0;">  matchExpressions:</span></span>
<span class="line"><span style="color:#B392F0;">    -</span><span style="color:#9ECBFF;"> key:</span><span style="color:#9ECBFF;"> kubernetes.io/metadata.name</span></span>
<span class="line"><span style="color:#B392F0;">      operator:</span><span style="color:#9ECBFF;"> NotIn</span></span>
<span class="line"><span style="color:#B392F0;">      values:</span></span>
<span class="line"><span style="color:#B392F0;">        -</span><span style="color:#9ECBFF;"> tenant-operator-system</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><strong>Option C: Temporarily disable webhook (emergency only)</strong></p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> delete</span><span style="color:#9ECBFF;"> validatingwebhookconfiguration</span><span style="color:#F97583;"> &lt;</span><span style="color:#9ECBFF;">webhook-nam</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#6A737D;"># Remember to restore after fixing root cause</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li></ol><h3 id="for-api-version-issues" tabindex="-1">For API Version Issues <a class="header-anchor" href="#for-api-version-issues" aria-label="Permalink to &quot;For API Version Issues&quot;">​</a></h3><ol><li><p><strong>Check deprecated API versions:</strong></p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># Check API version in template</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get</span><span style="color:#9ECBFF;"> tenanttemplate</span><span style="color:#F97583;"> &lt;</span><span style="color:#9ECBFF;">template-nam</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;"> -n</span><span style="color:#F97583;"> &lt;</span><span style="color:#9ECBFF;">namespac</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;"> \\</span></span>
<span class="line"><span style="color:#79B8FF;">  -o</span><span style="color:#9ECBFF;"> jsonpath=&#39;{.spec.deployments[0].spec.apiVersion}&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Check available API versions</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> api-resources</span><span style="color:#F97583;"> |</span><span style="color:#B392F0;"> grep</span><span style="color:#79B8FF;"> -i</span><span style="color:#E1E4E8;"> $RESOURCE_KIND</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li><li><p><strong>Update to current API version:</strong></p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> edit</span><span style="color:#9ECBFF;"> tenanttemplate</span><span style="color:#F97583;"> &lt;</span><span style="color:#9ECBFF;">template-nam</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;"> -n</span><span style="color:#F97583;"> &lt;</span><span style="color:#9ECBFF;">namespac</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Examples:</span></span>
<span class="line"><span style="color:#6A737D;"># Old: extensions/v1beta1 -&gt; New: apps/v1 (Deployments)</span></span>
<span class="line"><span style="color:#6A737D;"># Old: networking.k8s.io/v1beta1 -&gt; New: networking.k8s.io/v1 (Ingresses)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li></ol><h3 id="for-quota-issues" tabindex="-1">For Quota Issues <a class="header-anchor" href="#for-quota-issues" aria-label="Permalink to &quot;For Quota Issues&quot;">​</a></h3><ol><li><p><strong>Increase quota:</strong></p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> edit</span><span style="color:#9ECBFF;"> resourcequota</span><span style="color:#F97583;"> &lt;</span><span style="color:#9ECBFF;">quota-nam</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;"> -n</span><span style="color:#F97583;"> &lt;</span><span style="color:#9ECBFF;">namespac</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Increase limit for resource kind:</span></span>
<span class="line"><span style="color:#6A737D;"># spec:</span></span>
<span class="line"><span style="color:#6A737D;">#   hard:</span></span>
<span class="line"><span style="color:#6A737D;">#     deployments.apps: &quot;100&quot;  # Increase from current value</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li><li><p><strong>Or remove quota temporarily:</strong></p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> delete</span><span style="color:#9ECBFF;"> resourcequota</span><span style="color:#F97583;"> &lt;</span><span style="color:#9ECBFF;">quota-nam</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span><span style="color:#79B8FF;"> -n</span><span style="color:#F97583;"> &lt;</span><span style="color:#9ECBFF;">namespac</span><span style="color:#E1E4E8;">e</span><span style="color:#F97583;">&gt;</span></span>
<span class="line"><span style="color:#6A737D;"># Remember to restore with higher limits</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li></ol><h2 id="bulk-fix-for-affected-tenants" tabindex="-1">Bulk Fix for Affected Tenants <a class="header-anchor" href="#bulk-fix-for-affected-tenants" aria-label="Permalink to &quot;Bulk Fix for Affected Tenants&quot;">​</a></h2><p>After fixing root cause:</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># Force reconciliation of all tenants with failed resources</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get</span><span style="color:#9ECBFF;"> tenants</span><span style="color:#79B8FF;"> --all-namespaces</span><span style="color:#79B8FF;"> -o</span><span style="color:#9ECBFF;"> json</span><span style="color:#79B8FF;"> \\</span></span>
<span class="line"><span style="color:#F97583;">  |</span><span style="color:#B392F0;"> jq</span><span style="color:#79B8FF;"> -r</span><span style="color:#9ECBFF;"> &#39;.items[] | select(.status.failedResources &gt; 0) | &quot;\\(.metadata.namespace) \\(.metadata.name)&quot;&#39;</span><span style="color:#79B8FF;"> \\</span></span>
<span class="line"><span style="color:#F97583;">  |</span><span style="color:#F97583;"> while</span><span style="color:#79B8FF;"> read</span><span style="color:#9ECBFF;"> ns</span><span style="color:#9ECBFF;"> name</span><span style="color:#E1E4E8;">; </span><span style="color:#F97583;">do</span></span>
<span class="line"><span style="color:#79B8FF;">      echo</span><span style="color:#9ECBFF;"> &quot;Reconciling </span><span style="color:#E1E4E8;">$ns</span><span style="color:#9ECBFF;">/</span><span style="color:#E1E4E8;">$name</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="color:#B392F0;">      kubectl</span><span style="color:#9ECBFF;"> annotate</span><span style="color:#9ECBFF;"> tenant</span><span style="color:#E1E4E8;"> $name </span><span style="color:#79B8FF;">-n</span><span style="color:#E1E4E8;"> $ns </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#9ECBFF;">        tenant.operator.kubernetes-tenants.org/reconcile=&quot;$(</span><span style="color:#B392F0;">date</span><span style="color:#9ECBFF;"> +%s)&quot;</span><span style="color:#79B8FF;"> --overwrite</span></span>
<span class="line"><span style="color:#B392F0;">      sleep</span><span style="color:#79B8FF;"> 1</span></span>
<span class="line"><span style="color:#F97583;">    done</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Monitor recovery</span></span>
<span class="line"><span style="color:#B392F0;">watch</span><span style="color:#9ECBFF;"> &#39;kubectl get tenants --all-namespaces -o json | jq -r &quot;.items[] | select(.status.failedResources &gt; 0) | \\&quot;\\(.metadata.namespace)/\\(.metadata.name)\\&quot;&quot; | wc -l&#39;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h2 id="prevention" tabindex="-1">Prevention <a class="header-anchor" href="#prevention" aria-label="Permalink to &quot;Prevention&quot;">​</a></h2><ol><li><p><strong>Validate templates thoroughly:</strong></p><ul><li>Test all resource kinds in templates</li><li>Use <code>kubectl create --dry-run=server</code> to validate</li><li>Check API version compatibility</li><li>Ensure all required fields are present</li></ul></li><li><p><strong>Maintain RBAC properly:</strong></p><ul><li>Document required permissions</li><li>Test RBAC changes in staging</li><li>Monitor for permission denials</li><li>Regular RBAC audits</li></ul></li><li><p><strong>Template best practices:</strong></p><div class="language-yaml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># Always specify API version</span></span>
<span class="line"><span style="color:#85E89D;">apiVersion</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">apps/v1</span></span>
<span class="line"><span style="color:#85E89D;">kind</span><span style="color:#E1E4E8;">: </span><span style="color:#9ECBFF;">Deployment</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Provide defaults for optional fields</span></span>
<span class="line"><span style="color:#85E89D;">replicas</span><span style="color:#E1E4E8;">: {{ </span><span style="color:#9ECBFF;">.replicas | default 1</span><span style="color:#E1E4E8;"> }}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Validate required fields are present</span></span>
<span class="line"><span style="color:#E1E4E8;">{{- </span><span style="color:#9ECBFF;">if not .uid</span><span style="color:#E1E4E8;"> }}</span></span>
<span class="line"><span style="color:#E1E4E8;">{{- </span><span style="color:#9ECBFF;">fail &quot;uid is required&quot;</span><span style="color:#E1E4E8;"> }}</span></span>
<span class="line"><span style="color:#E1E4E8;">{{- </span><span style="color:#9ECBFF;">end</span><span style="color:#E1E4E8;"> }}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Use appropriate types</span></span>
<span class="line"><span style="color:#85E89D;">replicas</span><span style="color:#E1E4E8;">: {{ </span><span style="color:#9ECBFF;">.replicas | int</span><span style="color:#E1E4E8;"> }}  </span><span style="color:#6A737D;"># Ensure integer</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div></li><li><p><strong>Monitor apply metrics:</strong></p><div class="language-promql line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">promql</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span># Track apply failure rate by kind</span></span>
<span class="line"><span>rate(apply_attempts_total{result=&quot;failure&quot;}[5m]) by (kind)</span></span>
<span class="line"><span></span></span>
<span class="line"><span># Alert on any failures for critical resource kinds</span></span>
<span class="line"><span>rate(apply_attempts_total{result=&quot;failure&quot;, kind=&quot;Deployment&quot;}[5m]) &gt; 0</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li><li><p><strong>Test admission webhooks:</strong></p><ul><li>Test webhook policies with operator-generated resources</li><li>Ensure operator namespaces are excluded if appropriate</li><li>Document webhook requirements</li></ul></li></ol><h2 id="monitoring" tabindex="-1">Monitoring <a class="header-anchor" href="#monitoring" aria-label="Permalink to &quot;Monitoring&quot;">​</a></h2><div class="language-promql line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">promql</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span># Apply failure rate by kind</span></span>
<span class="line"><span>sum(rate(apply_attempts_total{result=&quot;failure&quot;}[5m])) by (kind)</span></span>
<span class="line"><span>  / sum(rate(apply_attempts_total[5m])) by (kind)</span></span>
<span class="line"><span></span></span>
<span class="line"><span># Total apply failures by kind</span></span>
<span class="line"><span>sum(increase(apply_attempts_total{result=&quot;failure&quot;}[1h])) by (kind)</span></span>
<span class="line"><span></span></span>
<span class="line"><span># Apply attempts by conflict policy</span></span>
<span class="line"><span>sum(rate(apply_attempts_total[5m])) by (kind, conflict_policy, result)</span></span>
<span class="line"><span></span></span>
<span class="line"><span># Success rate by kind</span></span>
<span class="line"><span>sum(rate(apply_attempts_total{result=&quot;success&quot;}[5m])) by (kind)</span></span>
<span class="line"><span>  / sum(rate(apply_attempts_total[5m])) by (kind)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="related-alerts" tabindex="-1">Related Alerts <a class="header-anchor" href="#related-alerts" aria-label="Permalink to &quot;Related Alerts&quot;">​</a></h2><ul><li><code>TenantResourcesFailed</code> - Individual tenant failures</li><li><code>TenantDegraded</code> - Tenants degraded due to apply failures</li><li><code>TenantReconciliationErrors</code> - Overall reconciliation errors</li></ul><h2 id="investigation-checklist" tabindex="-1">Investigation Checklist <a class="header-anchor" href="#investigation-checklist" aria-label="Permalink to &quot;Investigation Checklist&quot;">​</a></h2><ul><li>[ ] Identify which resource kind is failing</li><li>[ ] Check RBAC permissions for that kind</li><li>[ ] Verify resource specifications in templates</li><li>[ ] Check for admission webhooks blocking the kind</li><li>[ ] Review quota limits for the resource kind</li><li>[ ] Check API version compatibility</li><li>[ ] Review operator logs for specific errors</li><li>[ ] Test resource creation with dry-run</li><li>[ ] Check for recent cluster or operator changes</li></ul><h2 id="escalation" tabindex="-1">Escalation <a class="header-anchor" href="#escalation" aria-label="Permalink to &quot;Escalation&quot;">​</a></h2><p>If apply failures persist after troubleshooting:</p><ol><li><p>Collect diagnostics:</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># Operator logs filtered for failing kind</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> logs</span><span style="color:#79B8FF;"> -n</span><span style="color:#9ECBFF;"> tenant-operator-system</span><span style="color:#79B8FF;"> -l</span><span style="color:#9ECBFF;"> app=tenant-operator</span><span style="color:#79B8FF;"> --tail=5000</span><span style="color:#79B8FF;"> \\</span></span>
<span class="line"><span style="color:#F97583;">  |</span><span style="color:#B392F0;"> grep</span><span style="color:#9ECBFF;"> &quot;kind=</span><span style="color:#E1E4E8;">$FAILING_KIND</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#F97583;"> &gt;</span><span style="color:#9ECBFF;"> apply-failures-</span><span style="color:#E1E4E8;">$FAILING_KIND</span><span style="color:#9ECBFF;">.log</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># RBAC for failing kind</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get</span><span style="color:#9ECBFF;"> clusterrole</span><span style="color:#9ECBFF;"> tenant-operator-manager-role</span><span style="color:#79B8FF;"> -o</span><span style="color:#9ECBFF;"> yaml</span><span style="color:#F97583;"> &gt;</span><span style="color:#9ECBFF;"> rbac.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Template definitions</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get</span><span style="color:#9ECBFF;"> tenanttemplates</span><span style="color:#79B8FF;"> --all-namespaces</span><span style="color:#79B8FF;"> -o</span><span style="color:#9ECBFF;"> yaml</span><span style="color:#F97583;"> &gt;</span><span style="color:#9ECBFF;"> templates.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Sample failing resource</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get</span><span style="color:#9ECBFF;"> tenants</span><span style="color:#79B8FF;"> --all-namespaces</span><span style="color:#79B8FF;"> -o</span><span style="color:#9ECBFF;"> json</span><span style="color:#79B8FF;"> \\</span></span>
<span class="line"><span style="color:#F97583;">  |</span><span style="color:#B392F0;"> jq</span><span style="color:#79B8FF;"> -r</span><span style="color:#9ECBFF;"> &quot;.items[0].spec.\${</span><span style="color:#E1E4E8;">FAILING_KIND</span><span style="color:#9ECBFF;">}s[0]&quot;</span><span style="color:#F97583;"> &gt;</span><span style="color:#9ECBFF;"> sample-resource.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Admission webhooks</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get</span><span style="color:#9ECBFF;"> validatingwebhookconfigurations</span><span style="color:#79B8FF;"> -o</span><span style="color:#9ECBFF;"> yaml</span><span style="color:#F97583;"> &gt;</span><span style="color:#9ECBFF;"> webhooks-validating.yaml</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get</span><span style="color:#9ECBFF;"> mutatingwebhookconfigurations</span><span style="color:#79B8FF;"> -o</span><span style="color:#9ECBFF;"> yaml</span><span style="color:#F97583;"> &gt;</span><span style="color:#9ECBFF;"> webhooks-mutating.yaml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Resource quotas</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#9ECBFF;"> get</span><span style="color:#9ECBFF;"> resourcequotas</span><span style="color:#79B8FF;"> --all-namespaces</span><span style="color:#79B8FF;"> -o</span><span style="color:#9ECBFF;"> yaml</span><span style="color:#F97583;"> &gt;</span><span style="color:#9ECBFF;"> quotas.yaml</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div></li><li><p>Analyze patterns:</p><ul><li>Is it affecting all tenants or specific ones?</li><li>Did it start after a specific change?</li><li>Is it isolated to one resource kind?</li><li>Are there common error messages?</li></ul></li><li><p>If unable to resolve:</p><ul><li>Review with platform engineering</li><li>Check for operator bugs</li><li>Review Kubernetes API changes</li><li>Open GitHub issue with full diagnostics</li></ul></li></ol>`,49)])])}const b=n(p,[["render",o]]);export{y as __pageData,b as default};
